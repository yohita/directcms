"use strict";const e=require("express"),s=require("path");var a=require("express-ejs-layouts");const t=[{name:"directcms-hooks",config:({init:t,filter:i,action:o,schedule:l},{services:n,database:c,getSchema:r})=>{const{ItemsService:p}=n;async function d(e,s,a){console.log("Request was made to: "+e.path),global.DIRECT_CMS||await g();let t=e.path.split("/")[1],i="",o=[],l={},n=!1;if("blog"==t)if(e.path.split("/").length>2){i=e.path.split("/")[2];let s=await new p("posts",{schema:global.DIRECT_CMS.schema}).readByQuery({fields:["*","author.*"],filter:{status:"published",slug:i},sort:["published_at"]});s.length>0?l=s[0]:n=!0}else o=await new p("posts",{schema:global.DIRECT_CMS.schema}).readByQuery({fields:["*","author.*"],filter:{status:"published"},sort:["published_at"]});let c=new p("pages",{schema:global.DIRECT_CMS.schema}),r=await c.readByQuery({fields:["*","blocks.*","blocks.item.faqs.*","blocks.item.*.*.*"],filter:{_or:[{permalink:t,permalink:"/"+t}]}});const d=r.length>0?r[0]:{title:"Page not found",permalink:"404",blocks:[]};404==d.permalink&&(n=!0),s.render("index",{title:"Landing",layout:"layouts/layout.ejs",data:{page:d,posts:o,post:l,navigation_items:global.DIRECT_CMS.navigation_items,globals:global.DIRECT_CMS.globals,is_notfound:n}})}async function g(e=!1,s={collection:"xxx"}){if(e&&s){if(!["navigation","globals","pages","posts"].includes(s.collection))return void console.log("updateGlobals: skipping",s.collection);console.log("updateGlobals: updating",s.collection)}global.DIRECT_CMS||(global.DIRECT_CMS={}),global.DIRECT_CMS.schema||(global.DIRECT_CMS.schema=await r());let a=new p("navigation_items",{schema:global.DIRECT_CMS.schema}),t=new p("globals",{schema:global.DIRECT_CMS.schema}),i=await t.readByQuery({fields:["*"]}),o=await a.readByQuery({fields:["*","page.*","children.*","children.page.*"],sort:["sort"]});o=o.reduce((function(e,s){return e[s.navigation]=e[s.navigation]||[],e[s.navigation].push(s),e}),Object.create(null)),global.DIRECT_CMS.navigation_items=o,global.DIRECT_CMS.globals=i[0]}t("app.before",(({app:t})=>{const i=process.cwd();t.set("view engine","ejs"),t.use(a),t.use("/app",e.static(s.join(i,"app"))),t.set("views",s.join(i,"/web/views")),t.use("/app_assets",e.static(s.join(i,"app/app_assets"))),t.use("/web_assets",e.static(s.join(i,"web/web_assets"))),t.get("/",((e,s,a)=>d(e,s))),t.get("/app/*",((e,a,t)=>{""!==s.extname(e.path)?t():a.sendFile(s.join(i,"app","index.html"))})),t.get("*",(async function(e,s,a){let t=["auth","translations","api","activity","app","folders","server","admin","settings","assets","presets","flows","panels","collections","dashboards","notifications","relations","policies","revisions","comments","shares","versions","directcms-api","roles","permissions","fields","items","extensions","uploads","users","files","favicon.ico"];return process.env.SKIP_PATHS&&(t=t.concat(process.env.SKIP_PATHS.split(","))),t.some((s=>e.path.startsWith("/"+s)))?a():await d(e,s)}))})),o("items.create",(e=>{g(!0,e)})),o("items.update",(e=>{g(!0,e)}))}}],i=[{name:"directcms-api",config:(e,{services:s,database:a})=>{const{ItemsService:t}=s;e.get("/",((e,s)=>s.send("Hello, World!"))),e.get("/su",(async(e,s)=>{global.dcms_schema=e.schema})),e.get("/prepare-before-release",(async(e,s)=>{let t=await a("globals").update({logo_dark_mode:null,logo:null});s.send({data:t})})),e.get("/product-list-item-service-api-test",(async(e,s)=>{let a=new t("products",{schema:e.schema,accountability:e.accountability}),i=await a.readByQuery({fields:["id","name"],filter:{}});s.send({data:i})}))}}];exports.endpoints=i,exports.hooks=t,exports.operations=[];
